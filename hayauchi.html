<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—©æ‰“ã¡å˜èª</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: radial-gradient(circle at center, #232946 0%, #121629 100%);
      color: #fff;
      overflow: hidden;
      height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #start-screen, #game {
      display: none;
    }

    #start-screen.active, #game.active {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #start-screen input {
      width: 180px;
      padding: 6px;
      margin: 5px;
      border-radius: 6px;
      border: none;
      font-size: 1em;
      text-align: center;
    }

    #start-screen button {
      background-color: #eebbc3;
      border: none;
      color: #232946;
      font-size: 1.2em;
      padding: 10px 30px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      margin-top: 8px;
    }

    #start-screen button:hover {
      background-color: #ffd6dd;
    }

    #game-area {
      position: relative;
      width: 90vw;
      height: 60vh;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 15px;
    }
    #result-screen {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(35, 41, 70, 0.95);
  border: 2px solid #eebbc3;
  border-radius: 16px;
  padding: 40px 60px;
  text-align: center;
  display: none;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

#result-text {
  font-size: 2em;
  margin-bottom: 10px;
  color: #ffd6dd;
}

#clear-time {
  font-size: 1.3em;
  margin-bottom: 20px;
}

#retry-btn {
  background-color: #eebbc3;
  color: #232946;
  border: none;
  padding: 10px 25px;
  border-radius: 8px;
  font-size: 1.1em;
  cursor: pointer;
  transition: 0.2s;
}

#retry-btn:hover {
  background-color: #ffd6dd;
}


    .word {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      padding: 20px 30px;
      cursor: pointer;
      user-select: none;
      text-align: center;
      font-size: 1.1em;
      transition: 0.2s;
    }

    .word:hover {
      background-color: rgba(255, 255, 255, 0.35);
    }

    .wrong-flash {
      animation: flash 0.4s;
    }

    @keyframes flash {
      0%, 100% { background-color: #232946; }
      50% { background-color: rgba(255, 0, 0, 0.4); }
    }

    @keyframes shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-10px, 0); }
      50% { transform: translate(10px, 0); }
      75% { transform: translate(-10px, 0); }
      100% { transform: translate(0, 0); }
    }

    .shake {
      animation: shake 0.3s;
    }

    #game {
  position: relative;
  width: 100%;
  height: 100%;
}

#ui-bar {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  pointer-events: none; /* â†ã‚¯ãƒªãƒƒã‚¯è²«é€š */
}

  #life {
  font-size: 1.8em;
  color: #ff9c9c;
  margin-bottom: 8px;
  font-weight: bold;
}

#bullet {
  font-size: 1.6em;
  font-weight: bold;
  color: #fff;
}

#bullet span {
  color: #ffe66d; /* å¼¾ã®è‹±å˜èªéƒ¨åˆ†ã‚’ç›®ç«‹ãŸã›ã‚‹ */
  text-shadow: 0 0 8px #ffe66d;
}

  </style>
</head>
<body>
  <div id="start-screen" class="active">
    <h1>æ—©æ‰“ã¡å˜èª</h1>
    <p>ç¯„å›²æŒ‡å®š</p>
    <div>
      <input id="startRange" type="number" min="1" placeholder="é–‹å§‹ID">
      ï½
      <input id="endRange" type="number" min="1" placeholder="çµ‚äº†ID">
    </div>
    <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

 <div id="game">
  <div id="game-area"></div>
  <div id="ui-bar">
    <div id="life">ãƒ©ã‚¤ãƒ•ï¼šâ™¡â™¡â™¡</div>
    <div id="bullet">å¼¾ï¼š</div>
  </div>

  <!-- âœ… çµæœç”»é¢ -->
  <div id="result-screen">
    <h2 id="result-text"></h2>
    <p id="clear-time"></p>
    <button id="retry-btn">ãƒªãƒˆãƒ©ã‚¤</button>
  </div>
</div>


  <script>
    const startScreen = document.getElementById('start-screen');
    const startBtn = document.getElementById('startBtn');
    const game = document.getElementById('game');
    const gameArea = document.getElementById('game-area');
    const bulletElem = document.getElementById('bullet');
    const lifeElem = document.getElementById('life');
    const startRangeInput = document.getElementById('startRange');
    const endRangeInput = document.getElementById('endRange');

    let words = [];
    let selectedWords = [];
    let currentWord = null;
    let currentIndex = 0;
    let lives = 3;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    async function loadWords() {
      const res = await fetch('words.json');
      words = await res.json();
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }


function playSound(type) {
  const osc1 = audioCtx.createOscillator();
  const gain1 = audioCtx.createGain();
  osc1.connect(gain1);
  gain1.connect(audioCtx.destination);

  if (type === 'correct') {
    // ğŸ¯ã€Œã´ã“ã£ã€åŠ¹æœéŸ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
    osc1.type = "square";
    osc1.frequency.setValueAtTime(500, audioCtx.currentTime);
    osc1.frequency.linearRampToValueAtTime(900, audioCtx.currentTime + 0.08);
    gain1.gain.setValueAtTime(0.12, audioCtx.currentTime);
    gain1.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.18);
    osc1.start();
    osc1.stop(audioCtx.currentTime + 0.18);

  } else if (type === 'wrong') {
    // âŒã€Œãƒ–ãƒ–ãƒƒã€åŠ¹æœéŸ³ï¼ˆæŸ”ã‚‰ã‹ã‚ã§ãƒ†ãƒ³ãƒè‰¯ãï¼‰
    const now = audioCtx.currentTime;

    // 1å›ç›®
    const oscA = audioCtx.createOscillator();
    const gainA = audioCtx.createGain();
    oscA.connect(gainA);
    gainA.connect(audioCtx.destination);
    oscA.type = "triangle";
    oscA.frequency.setValueAtTime(210, now);
    gainA.gain.setValueAtTime(0.2, now);
    gainA.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
    oscA.start(now);
    oscA.stop(now + 0.12);

    // 2å›ç›®
    const oscB = audioCtx.createOscillator();
    const gainB = audioCtx.createGain();
    oscB.connect(gainB);
    gainB.connect(audioCtx.destination);
    oscB.type = "triangle";
    oscB.frequency.setValueAtTime(175, now + 0.13);
    gainB.gain.setValueAtTime(0.18, now + 0.13);
    gainB.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
    oscB.start(now + 0.13);
    oscB.stop(now + 0.25);
  }
}





function getNonOverlappingPosition(existing, element, padding = 25) {
  let x, y, valid;
  let attempts = 0;
  const maxAttempts = 1000;

  const wordWidth = element.offsetWidth;
  const wordHeight = element.offsetHeight;

  do {
    valid = true;
    x = Math.random() * (gameArea.offsetWidth - wordWidth - 10);
    y = Math.random() * (gameArea.offsetHeight - wordHeight - 10);

    for (const pos of existing) {
      if (
        x < pos.x + pos.width + padding &&
        x + wordWidth + padding > pos.x &&
        y < pos.y + pos.height + padding &&
        y + wordHeight + padding > pos.y
      ) {
        valid = false;
        break;
      }
    }

    attempts++;
  } while (!valid && attempts < maxAttempts);

  existing.push({ x, y, width: wordWidth, height: wordHeight });
  return { x, y };
}


let startTime; // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²

function startGame() {
  const start = parseInt(startRangeInput.value);
  const end = parseInt(endRangeInput.value);

  if (isNaN(start) || isNaN(end) || start >= end) {
    alert("æ­£ã—ã„ç¯„å›²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  selectedWords = words.filter(w => w.id >= start && w.id <= end);
  selectedWords = shuffle(selectedWords);

  if (selectedWords.length > 20) selectedWords = selectedWords.slice(0, 20);

  startScreen.classList.remove('active');
  game.classList.add('active');

  startTime = performance.now(); // âœ… ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
  setupGame();
}

function setupGame() {
  gameArea.innerHTML = '';
  document.getElementById('result-screen').style.display = 'none'; // ãƒªã‚»ãƒƒãƒˆ
  currentIndex = 0;
  lives = 3;
  updateLife();
  const positions = [];

  selectedWords.forEach((word) => {
    const el = document.createElement('div');
    el.className = 'word';
    el.textContent = word.jp;

    // âœ… å…ˆã«è¿½åŠ ã—ã¦ã‚µã‚¤ã‚ºã‚’å–å¾—ã—ã¦ã‹ã‚‰ä½ç½®ã‚’æ±ºå®šï¼ˆãã¡ã‚ƒãã¡ã‚ƒå¯¾ç­–ï¼‰
    gameArea.appendChild(el);
    const pos = getNonOverlappingPosition(positions, el);
    el.style.left = `${pos.x}px`;
    el.style.top = `${pos.y}px`;

    el.addEventListener('click', () => {
      if (!currentWord) return;

      if (word.en === currentWord.en) {
        playSound('correct');
        el.remove();
        currentIndex++;

        if (currentIndex < selectedWords.length) {
          showNextWord();
        } else {
          showResultScreen(); // âœ… æœ€å¾Œã«çµæœç”»é¢ã‚’è¡¨ç¤º
        }
      } else {
        handleWrong();
      }
    });
  });

  showNextWord();
}

function showResultScreen() {
  const clearTime = ((performance.now() - startTime) / 1000).toFixed(2);
  const resultScreen = document.getElementById('result-screen');
  const resultText = document.getElementById('result-text');
  const clearTimeElem = document.getElementById('clear-time');

  // âœ… è¡¨ç¤ºå†…å®¹è¨­å®š
  resultText.textContent = "ã‚¯ãƒªã‚¢ï¼";
  clearTimeElem.textContent = `ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ï¼š${clearTime} ç§’`;

  // âœ… çµæœç”»é¢ã‚’ä¸­å¤®ã«ãƒ•ã‚§ãƒ¼ãƒ‰è¡¨ç¤º
  resultScreen.style.display = "flex";
  resultScreen.style.opacity = "0";
  resultScreen.style.transition = "opacity 0.4s";
  requestAnimationFrame(() => {
    resultScreen.style.opacity = "1";
  });

  // âœ… ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
  document.getElementById('retry-btn').onclick = () => location.reload();
}


function showResultScreen() {
  const clearTime = ((performance.now() - startTime) / 1000).toFixed(2);
  const resultScreen = document.getElementById('result-screen');
  const resultText = document.getElementById('result-text');
  const clearTimeElem = document.getElementById('clear-time');

  resultText.textContent = "ã‚¯ãƒªã‚¢ï¼";
  clearTimeElem.textContent = `ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ï¼š${clearTime} ç§’`;
  resultScreen.style.display = "flex";

  document.getElementById('retry-btn').onclick = () => location.reload();
}


function showNextWord() {
  currentWord = selectedWords[currentIndex];
  bulletElem.innerHTML = `å¼¾ï¼š<span>${currentWord.en}</span>`;
}



    function handleWrong() {
      playSound('wrong');
      lives--;
      updateLife();

      document.body.classList.add('wrong-flash', 'shake');
      setTimeout(() => {
        document.body.classList.remove('wrong-flash', 'shake');
      }, 400);

      if (lives <= 0) {
        alert("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼");
        location.reload();
      }
    }

    function updateLife() {
      lifeElem.textContent = "ãƒ©ã‚¤ãƒ•ï¼š" + "â™¡".repeat(lives);
    }

    loadWords();
    // éŸ³ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å†é–‹
window.addEventListener('click', () => {
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
});

    startBtn.addEventListener('click', startGame);
  </script>
</body>
</html>
